<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Instant Camera App</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden; /* Prevent scrolling when dragging */
        touch-action: none;
        user-select: none; /* 全局禁止文字选择 */
        -webkit-user-select: none;
      }

      /* Custom Font for the Polaroid Text */
      .handwritten {
        font-family: "Permanent Marker", cursive;
      }

      /* Flash Animation */
      @keyframes flash-animation {
        0% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }
      .flash-active {
        animation: flash-animation 0.8s ease-out forwards;
      }

      /* Photo Ejection Animation - Stops halfway */
      @keyframes eject-photo-partial {
        0% {
          transform: translateY(100%);
        }
        100% {
          transform: translateY(-60%);
        }
      }
      .ejecting {
        animation: eject-photo-partial 0.8s cubic-bezier(0.25, 1, 0.5, 1)
          forwards;
      }

      /* Developing Effect (显影效果) - 2s */
      @keyframes develop-image {
        0% {
          filter: blur(8px) grayscale(1) brightness(1.8) contrast(0.8);
          opacity: 0.9;
        }
        50% {
          filter: blur(4px) grayscale(0.6) brightness(1.2);
        }
        100% {
          filter: blur(0) grayscale(0) brightness(1) contrast(1);
          opacity: 1;
        }
      }
      /* 只有带有 developing 类的元素才会执行显影动画 */
      .developing img {
        animation: develop-image 2s ease-in-out forwards;
      }

      /* Dragging & Selection Styles */
      .draggable {
        cursor: grab;
        position: absolute;
        transition: box-shadow 0.4s cubic-bezier(0.25, 0.8, 0.25, 1),
          transform 0.3s ease;
        touch-action: none;
        will-change: transform, box-shadow;
      }

      .draggable.is-dragging {
        cursor: grabbing;
        z-index: 1000 !important;
        transform: scale(1.05) rotate(0deg) !important;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3);
        transition: none;
      }

      .selected-photo {
        z-index: 50;
        transform: scale(1.02);
        box-shadow: 0 35px 60px -15px rgba(0, 0, 0, 0.4);
      }

      .in-printer {
        z-index: 0;
        cursor: grab;
      }
      .in-printer:hover {
        transform: translateY(-65%) !important;
      }

      /* Range Slider Styling */
      input[type="range"] {
        -webkit-appearance: none;
        background: transparent;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 16px;
        width: 16px;
        border-radius: 50%;
        background: #ec4899; /* Pink-500 */
        cursor: pointer;
        margin-top: -6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }
      input[type="range"]::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        cursor: pointer;
        background: #e5e7eb;
        border-radius: 2px;
      }
    </style>
  </head>
  <body
    class="bg-gray-100 h-screen w-screen relative flex flex-col md:flex-row overflow-hidden"
  >
    <!-- Flash Overlay -->
    <div
      id="flash-overlay"
      class="fixed inset-0 bg-white pointer-events-none opacity-0 z-[9999]"
    ></div>

    <!-- Header / Controls -->
    <div
      class="absolute top-4 right-4 z-50 flex items-center gap-3 flex-wrap justify-end pointer-events-none"
    >
      <!-- Beauty Control -->
      <div
        class="bg-white/90 backdrop-blur-sm border border-gray-200 px-4 py-2 rounded-full shadow-md flex items-center gap-2 pointer-events-auto"
      >
        <span class="text-xs font-bold text-gray-500 uppercase tracking-wide"
          >Beauty</span
        >
        <input
          id="beauty-slider"
          type="range"
          min="0"
          max="10"
          value="5"
          class="w-24 accent-pink-500"
        />
        <span
          id="beauty-val"
          class="text-xs font-bold text-pink-500 w-4 text-center"
          >5</span
        >
      </div>

      <button
        id="delete-btn"
        class="bg-white border-2 border-red-500 text-red-500 px-5 py-2 rounded-full font-bold hover:bg-red-50 transition shadow-lg cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed select-none hidden md:block pointer-events-auto"
      >
        DELETE
      </button>
      <button
        id="download-btn"
        class="bg-white border-2 border-black px-5 py-2 rounded-full font-bold hover:bg-gray-100 transition shadow-lg cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed select-none pointer-events-auto"
      >
        DOWNLOAD
      </button>
    </div>

    <!-- Left Side: Camera Area -->
    <div
      class="w-full h-1/2 md:w-1/2 md:h-full flex items-center justify-center relative p-4"
      id="camera-zone"
    >
      <!-- Camera Container -->
      <div
        class="relative w-[320px] md:w-[450px] transition-all duration-500"
        id="camera-container"
      >
        <!-- The Ejecting Photo Slot (Behind Camera) -->
        <div
          class="absolute top-0 left-1/2 -translate-x-1/2 w-[160px] h-[240px] z-0"
          id="printer-slot"
        >
          <!-- Photos will be appended here -->
        </div>

        <!-- Camera Image -->
        <img
          src="https://wgzhao.me/images/img/X5CczwV7I?w=800&fm=png"
          alt="Instant Camera"
          class="w-full relative z-20 pointer-events-none drop-shadow-2xl select-none"
          id="camera-img"
        />

        <!-- Webcam Feed (Lens) -->
        <!-- Initial Style Hidden to prevent jump, JS will show it after positioning -->
        <div
          id="lens-wrapper"
          class="absolute z-30 overflow-hidden rounded-full bg-[#111] border-4 border-gray-800/50 shadow-inner"
          style="opacity: 0; transition: opacity 0.3s"
        >
          <video
            id="webcam"
            autoplay
            playsinline
            muted
            class="w-full h-full object-cover transform scale-x-[-1]"
          ></video>
        </div>

        <!-- Shutter Button Area -->
        <div
          id="shutter-btn"
          class="absolute z-40 rounded-full cursor-pointer hover:bg-white/10 active:bg-white/20 transition"
          title="Take Photo"
        ></div>

        <!-- Indicator Light -->
        <div
          id="status-light"
          class="absolute top-[18%] right-[28%] w-3 h-3 rounded-full bg-red-500 z-30 shadow-[0_0_10px_red] transition-colors duration-300"
        ></div>
      </div>
    </div>

    <!-- Right Side: Photo Gallery / Drop Zone -->
    <div
      class="w-full h-1/2 md:w-1/2 md:h-full bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:16px_16px] relative overflow-hidden"
      id="gallery-zone"
    >
      <div
        class="absolute inset-0 pointer-events-none flex items-center justify-center text-gray-300 font-bold text-4xl uppercase tracking-widest select-none opacity-50"
      >
        Drop Here
      </div>
    </div>

    <!-- Hidden Canvas for rendering download image -->
    <canvas id="render-canvas" class="hidden"></canvas>

    <script>
      // --- CONFIGURATION ---
      const CAMERA_CONFIG = {
        lensTop: 50.5,
        lensLeft: 52.5,
        lensSize: 20.5,
        btnTop: 36,
        btnLeft: 15,
        btnSize: 10,
      };

      // --- STATE ---
      let selectedPhotoId = null;
      let dragItem = null;
      let dragOffset = { x: 0, y: 0 };
      let startPos = { x: 0, y: 0 };
      let isDragging = false;
      let zIndexCounter = 100;
      let audioContext = null;

      // --- DOM ---
      const video = document.getElementById("webcam");
      const lensWrapper = document.getElementById("lens-wrapper");
      const shutterBtn = document.getElementById("shutter-btn");
      const flashOverlay = document.getElementById("flash-overlay");
      const printerSlot = document.getElementById("printer-slot");
      const galleryZone = document.getElementById("gallery-zone");
      const statusLight = document.getElementById("status-light");
      const downloadBtn = document.getElementById("download-btn");
      const deleteBtn = document.getElementById("delete-btn");
      const beautySlider = document.getElementById("beauty-slider");
      const beautyVal = document.getElementById("beauty-val");

      // --- INIT ---
      async function initCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: true,
          });
          video.srcObject = stream;
          statusLight.classList.remove("bg-red-500", "shadow-[0_0_10px_red]");
          statusLight.classList.add("bg-green-500", "shadow-[0_0_10px_green]");
        } catch (err) {
          console.warn("Camera fallback", err);
          video.style.display = "none";
          lensWrapper.style.backgroundColor = "#1a1a1a";
        }
        document.addEventListener("click", initAudioContext, { once: true });
        document.addEventListener("keydown", initAudioContext, { once: true });
        updateControls();
        // Calibration is now called immediately at the end of script
      }

      function initAudioContext() {
        if (!audioContext) {
          const AudioContext = window.AudioContext || window.webkitAudioContext;
          if (AudioContext) audioContext = new AudioContext();
        } else if (audioContext.state === "suspended") {
          audioContext.resume();
        }
      }

      function applyCalibration() {
        lensWrapper.style.top = `${CAMERA_CONFIG.lensTop}%`;
        lensWrapper.style.left = `${CAMERA_CONFIG.lensLeft}%`;
        lensWrapper.style.width = `${CAMERA_CONFIG.lensSize}%`;
        lensWrapper.style.height = `${CAMERA_CONFIG.lensSize}%`;
        lensWrapper.style.aspectRatio = "1/1";

        // Show lens after positioning
        lensWrapper.style.opacity = "1";

        shutterBtn.style.top = `${CAMERA_CONFIG.btnTop}%`;
        shutterBtn.style.left = `${CAMERA_CONFIG.btnLeft}%`;
        shutterBtn.style.width = `${CAMERA_CONFIG.btnSize}%`;
        shutterBtn.style.aspectRatio = "1/1";
      }

      beautySlider.addEventListener(
        "input",
        (e) => (beautyVal.innerText = e.target.value)
      );

      // --- SOUND ---
      function playShutterSound() {
        initAudioContext();
        if (!audioContext) return;
        const t = audioContext.currentTime;

        // Mechanical Click
        const oscLow = audioContext.createOscillator();
        const gainLow = audioContext.createGain();
        oscLow.type = "square";
        oscLow.frequency.setValueAtTime(150, t);
        oscLow.frequency.exponentialRampToValueAtTime(40, t + 0.1);
        gainLow.gain.setValueAtTime(0.5, t);
        gainLow.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
        oscLow.connect(gainLow);
        gainLow.connect(audioContext.destination);
        oscLow.start(t);
        oscLow.stop(t + 0.1);

        // High Snap
        const oscHigh = audioContext.createOscillator();
        const gainHigh = audioContext.createGain();
        oscHigh.type = "sawtooth";
        oscHigh.frequency.setValueAtTime(800, t);
        oscHigh.frequency.exponentialRampToValueAtTime(100, t + 0.15);
        gainHigh.gain.setValueAtTime(0.3, t);
        gainHigh.gain.exponentialRampToValueAtTime(0.01, t + 0.15);
        oscHigh.connect(gainHigh);
        gainHigh.connect(audioContext.destination);
        oscHigh.start(t);
        oscHigh.stop(t + 0.15);

        // Motor Noise
        const bufferSize = audioContext.sampleRate * 0.15;
        const buffer = audioContext.createBuffer(
          1,
          bufferSize,
          audioContext.sampleRate
        );
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
        const noise = audioContext.createBufferSource();
        noise.buffer = buffer;
        const noiseGain = audioContext.createGain();
        noiseGain.gain.setValueAtTime(0.8, t);
        noiseGain.gain.exponentialRampToValueAtTime(0.01, t + 0.15);
        noise.connect(noiseGain);
        noiseGain.connect(audioContext.destination);
        noise.start(t);
      }

      // --- CORE BEAUTY ALGORITHM ---
      function applySmartSmooth(ctx, width, height, level) {
        if (level <= 0) return;

        const originalImageData = ctx.getImageData(0, 0, width, height);
        const src = originalImageData.data;

        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = width;
        tempCanvas.height = height;
        const tempCtx = tempCanvas.getContext("2d");

        const blurRadius = 2 + level * 1.5;
        tempCtx.filter = `blur(${blurRadius}px)`;
        tempCtx.drawImage(ctx.canvas, 0, 0, width, height);

        const blurredImageData = tempCtx.getImageData(0, 0, width, height);
        const blurred = blurredImageData.data;

        const outputImageData = ctx.createImageData(width, height);
        const dst = outputImageData.data;

        const edgeThreshold = 15 + level * 2;

        for (let i = 0; i < src.length; i += 4) {
          const r = src[i];
          const g = src[i + 1];
          const b = src[i + 2];
          const a = src[i + 3];

          // Simple Skin Detection
          const isSkin =
            r > 45 &&
            g > 40 &&
            b > 20 &&
            r > g &&
            r > b &&
            Math.abs(r - g) > 10;

          if (isSkin) {
            const rB = blurred[i];
            const gB = blurred[i + 1];
            const bB = blurred[i + 2];

            const delta =
              Math.abs(r - rB) + Math.abs(g - gB) + Math.abs(b - bB);

            let factor = 0;
            if (delta < edgeThreshold) {
              factor = 1 - delta / edgeThreshold;
              factor = Math.min(factor * (level / 5), 0.8);
            }

            dst[i] = r * (1 - factor) + rB * factor;
            dst[i + 1] = g * (1 - factor) + gB * factor;
            dst[i + 2] = b * (1 - factor) + bB * factor;
          } else {
            dst[i] = r;
            dst[i + 1] = g;
            dst[i + 2] = b;
          }
          dst[i + 3] = a;
        }

        ctx.putImageData(outputImageData, 0, 0);
      }

      function applyWhitening(ctx, width, height, level) {
        if (level <= 0) return;

        ctx.save();
        ctx.globalCompositeOperation = "soft-light";
        ctx.fillStyle = `rgba(255, 250, 240, ${level * 0.06})`; // Warm white
        ctx.fillRect(0, 0, width, height);
        ctx.globalCompositeOperation = "source-over";
        ctx.restore();
      }

      shutterBtn.addEventListener("click", takePhoto);

      function takePhoto() {
        playShutterSound();
        flashOverlay.classList.remove("flash-active");
        void flashOverlay.offsetWidth;
        flashOverlay.classList.add("flash-active");

        const canvas = document.createElement("canvas");
        const targetWidth = 600;
        const targetHeight = 800;
        canvas.width = targetWidth;
        canvas.height = targetHeight;
        const ctx = canvas.getContext("2d");

        const isCameraActive =
          video.style.display !== "none" &&
          video.srcObject &&
          video.srcObject.active;
        const level = parseInt(beautySlider.value);

        if (isCameraActive) {
          try {
            const videoRatio = video.videoWidth / video.videoHeight;
            const targetRatio = targetWidth / targetHeight;
            let renderW, renderH, sX, sY;
            if (videoRatio > targetRatio) {
              renderH = video.videoHeight;
              renderW = video.videoHeight * targetRatio;
              sX = (video.videoWidth - renderW) / 2;
              sY = 0;
            } else {
              renderW = video.videoWidth;
              renderH = video.videoWidth / targetRatio;
              sX = 0;
              sY = (video.videoHeight - renderH) / 2;
            }

            ctx.translate(targetWidth, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(
              video,
              sX,
              sY,
              renderW,
              renderH,
              0,
              0,
              targetWidth,
              targetHeight
            );
            ctx.setTransform(1, 0, 0, 1, 0, 0);

            applySmartSmooth(ctx, targetWidth, targetHeight, level);
            applyWhitening(ctx, targetWidth, targetHeight, level);
          } catch (e) {
            console.error(e);
            drawFallbackImage(ctx, targetWidth, targetHeight);
          }
        } else {
          drawFallbackImage(ctx, targetWidth, targetHeight);
        }

        const imgDataUrl = canvas.toDataURL("image/png");
        const timestamp = new Date().toLocaleString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "numeric",
          minute: "numeric",
          hour12: true,
        });

        createPolaroid(imgDataUrl, timestamp);
      }

      function drawFallbackImage(ctx, w, h) {
        ctx.fillStyle = "#111111";
        ctx.fillRect(0, 0, w, h);
        for (let i = 0; i < 80000; i++) {
          const x = Math.random() * w;
          const y = Math.random() * h;
          const b = Math.random() * 20 + 10;
          ctx.fillStyle = `rgba(${b}, ${b}, ${b}, 0.1)`;
          ctx.fillRect(x, y, 2, 2);
        }
        const gradient = ctx.createRadialGradient(
          w / 2,
          h / 2,
          w * 0.3,
          w / 2,
          h / 2,
          w * 0.8
        );
        gradient.addColorStop(0, "transparent");
        gradient.addColorStop(1, "rgba(0,0,0,0.8)");
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, w, h);
      }

      function createPolaroid(imgUrl, dateText) {
        const id = Date.now();
        const polaroid = document.createElement("div");
        polaroid.className =
          "absolute bg-[#fdfdfd] shadow-lg p-3 flex flex-col items-center justify-start in-printer developing draggable";
        polaroid.style.width = "160px";
        polaroid.style.height = "240px";
        polaroid.style.paddingBottom = "30px";
        polaroid.id = `photo-${id}`;

        const img = document.createElement("img");
        img.src = imgUrl;
        img.className =
          "w-full aspect-[3/4] object-cover bg-gray-900 pointer-events-none select-none";
        img.draggable = false;

        const label = document.createElement("div");
        label.className =
          "handwritten text-gray-600 text-xs mt-3 text-center w-full leading-tight pointer-events-none select-none";
        label.innerText = dateText;

        polaroid.appendChild(img);
        polaroid.appendChild(label);
        printerSlot.appendChild(polaroid);

        setTimeout(() => polaroid.classList.add("ejecting"), 200);

        polaroid.addEventListener("mousedown", startDrag);
        polaroid.addEventListener("touchstart", startDrag, { passive: false });
        polaroid.addEventListener("click", (e) => e.stopPropagation());
      }

      // --- DRAG LOGIC ---
      function startDrag(e) {
        if (e.type === "touchstart") e.preventDefault();
        initAudioContext();
        dragItem = e.currentTarget;
        isDragging = false;
        const clientX =
          e.type === "touchstart" ? e.touches[0].clientX : e.clientX;
        const clientY =
          e.type === "touchstart" ? e.touches[0].clientY : e.clientY;
        startPos = { x: clientX, y: clientY };
        const rect = dragItem.getBoundingClientRect();
        dragOffset.x = clientX - rect.left;
        dragOffset.y = clientY - rect.top;
        selectPhoto(dragItem);
        zIndexCounter++;
        dragItem.style.zIndex = zIndexCounter;
        document.addEventListener("mousemove", onDrag);
        document.addEventListener("mouseup", stopDrag);
        document.addEventListener("touchmove", onDrag, { passive: false });
        document.addEventListener("touchend", stopDrag);
      }

      function onDrag(e) {
        if (!dragItem) return;
        if (e.type === "touchmove") e.preventDefault();
        const clientX =
          e.type === "touchmove" ? e.touches[0].clientX : e.clientX;
        const clientY =
          e.type === "touchmove" ? e.touches[0].clientY : e.clientY;
        if (!isDragging) {
          const dx = Math.abs(clientX - startPos.x);
          const dy = Math.abs(clientY - startPos.y);
          if (dx > 3 || dy > 3) {
            isDragging = true;
            dragItem.classList.add("is-dragging");
            if (dragItem.parentNode !== document.body) {
              const rect = dragItem.getBoundingClientRect();
              dragItem.style.left = `${rect.left}px`;
              dragItem.style.top = `${rect.top}px`;
              dragItem.style.transform = "none";
              dragItem.classList.remove("ejecting", "in-printer", "developing");
              document.body.appendChild(dragItem);
            }
          }
        }
        if (isDragging) {
          dragItem.style.left = `${clientX - dragOffset.x}px`;
          dragItem.style.top = `${clientY - dragOffset.y}px`;
        }
      }

      function stopDrag(e) {
        if (!dragItem) return;
        dragItem.classList.remove("is-dragging");
        if (isDragging) {
          const galleryRect = galleryZone.getBoundingClientRect();
          const itemRect = dragItem.getBoundingClientRect();
          const itemCenter = {
            x: itemRect.left + itemRect.width / 2,
            y: itemRect.top + itemRect.height / 2,
          };
          if (itemCenter.x > galleryRect.left) {
            const randomRot = Math.random() * 8 - 4;
            dragItem.style.transform = `rotate(${randomRot}deg)`;
          }
        }
        dragItem = null;
        document.removeEventListener("mousemove", onDrag);
        document.removeEventListener("mouseup", stopDrag);
        document.removeEventListener("touchmove", onDrag);
        document.removeEventListener("touchend", stopDrag);
      }

      function selectPhoto(el) {
        document
          .querySelectorAll(".selected-photo")
          .forEach((p) => p.classList.remove("selected-photo"));
        el.classList.add("selected-photo");
        selectedPhotoId = el.id;
        updateControls();
      }
      function deselectAll() {
        document
          .querySelectorAll(".selected-photo")
          .forEach((p) => p.classList.remove("selected-photo"));
        selectedPhotoId = null;
        updateControls();
      }
      function updateControls() {
        const has = !!selectedPhotoId;
        downloadBtn.disabled = !has;
        deleteBtn.disabled = !has;
        if (has) deleteBtn.classList.remove("hidden");
      }
      function deleteSelectedPhoto() {
        if (selectedPhotoId) {
          const el = document.getElementById(selectedPhotoId);
          if (el) {
            el.style.transition = "transform 0.2s, opacity 0.2s";
            el.style.transform = "scale(0.5)";
            el.style.opacity = "0";
            setTimeout(() => el.remove(), 200);
          }
          deselectAll();
        }
      }
      document.addEventListener("mousedown", (e) => {
        if (
          !e.target.closest(".draggable") &&
          !e.target.closest("button") &&
          !e.target.closest("input")
        )
          deselectAll();
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Delete" || e.key === "Backspace") deleteSelectedPhoto();
      });
      deleteBtn.addEventListener("click", deleteSelectedPhoto);
      downloadBtn.addEventListener("click", () => {
        if (selectedPhotoId)
          downloadPolaroid(document.getElementById(selectedPhotoId));
      });

      function downloadPolaroid(element) {
        const canvas = document.getElementById("render-canvas");
        const ctx = canvas.getContext("2d");
        const img = element.querySelector("img");
        const text = element.innerText;
        const cardWidth = 600;
        const cardHeight = 860;
        const padding = 40;
        canvas.width = cardWidth;
        canvas.height = cardHeight;
        ctx.fillStyle = "#fdfdfd";
        ctx.fillRect(0, 0, cardWidth, cardHeight);
        const imgWidth = cardWidth - 40 - padding * 2;
        const imgHeight = imgWidth * (4 / 3);
        ctx.drawImage(img, 20 + padding, 20 + padding, imgWidth, imgHeight);
        ctx.fillStyle = "#333333";
        ctx.font = '40px "Permanent Marker", cursive';
        ctx.textAlign = "center";
        ctx.fillText(text, cardWidth / 2, cardHeight - 60);
        const link = document.createElement("a");
        link.download = `polaroid-${Date.now()}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
      }

      // Start execution immediately to fix positioning
      applyCalibration();
      initCamera();
      window.addEventListener("resize", applyCalibration);
    </script>
  </body>
</html>
